import * as PIXI from 'pixi.js';
import { drawScenePixi, drawVisibilityTriangles } from './draw-scene-pixi';
import { loadMap, processSegments } from './load-map';
import { calculateVisibility } from './visibility';
import { Rectangle } from './rectangle';
import { Segment } from './segment';
import { Point } from './point';
import { GradientFactory, ColorStop } from '@pixi-essentials/gradients';
import { Application, Graphics, Container } from 'pixi.js'
import "../style.scss"

import SegmentShape from "./segment-shape"


// Prepare canvas
const canvas = document.getElementById('scene') as HTMLCanvasElement;


const app = new Application({
  width: 800,
  height: 800,
  backgroundColor: 0x000000,
  view: canvas,
  antialias: true
})
document.body.appendChild(app.view)


let texture = PIXI.RenderTexture.create({ width: 512, height: 512 });
let gradient = GradientFactory.createRadialGradient(
  app.renderer as PIXI.Renderer,
  texture,
  {
    x0: 256,
    y0: 256,
    r0: 0,
    x1: 256,
    y1: 256,
    r1: 256,
    colorStops: [
      {
        offset: 0,
        color: 0xddddaaff,
      },
      {
        offset: 0.2,
        color: 0x33333355,
      },
      {
        offset: 1,
        color: 0x000000,
      }
    ]
  }
);



const shapes: SegmentShape[] = [];
let shape1 = new SegmentShape([
  new Segment(-250.0, 23.1456832886, -241.767196655, 11.9338035583),
  new Segment(-241.767196655, 11.9338035583, -237.676635742, 11.6712789536),
  new Segment(-237.676635742, 11.6712789536, -224.152191162, 18.6769046783),
  new Segment(-224.152191162, 18.6769046783, -217.176055908, 19.1246204376),
  new Segment(-217.176055908, 19.1246204376, -211.932693481, 17.8496398926),
  new Segment(-211.932693481, 17.8496398926, -208.929367065, 15.607667923),
  new Segment(-208.929367065, 15.607667923, -207.199981689, 12.3363618851),
  new Segment(-207.199981689, 12.3363618851, -207.233581543, 5.6889166832),
  new Segment(-207.233581543, 5.6889166832, -211.452636719, 1.50672161579),
  new Segment(-211.452636719, 1.50672161579, -235.289810181, -7.68527841568),
  new Segment(-235.289810181, -7.68527841568, -241.479095459, -13.2767963409),
  new Segment(-241.479095459, -13.2767963409, -244.742858887, -19.4795570374),
  new Segment(-244.742858887, -19.4795570374, -246.008682251, -27.7131767273),
  new Segment(-246.008682251, -27.7131767273, -245.07131958, -35.4991760254),
  new Segment(-245.07131958, -35.4991760254, -241.774505615, -42.6573143005),
  new Segment(-241.774505615, -42.6573143005, -236.320480347, -48.5729904175),
  new Segment(-236.320480347, -48.5729904175, -228.828231812, -52.831073761),
  new Segment(-228.828231812, -52.831073761, -221.402481079, -54.7079582214),
  new Segment(-221.402481079, -54.7079582214, -211.48449707, -54.7960929871),
  new Segment(-211.48449707, -54.7960929871, -202.667388916, -52.9187202454),
  new Segment(-202.667388916, -52.9187202454, -194.958633423, -49.2873039246),
  new Segment(-194.958633423, -49.2873039246, -190.871505737, -46.2253112793),
  new Segment(-190.871505737, -46.2253112793, -189.066329956, -44.5711784363),
  new Segment(-189.066329956, -44.5711784363, -196.259185791, -33.0164222717),
  new Segment(-196.259185791, -33.0164222717, -201.453918457, -32.9904937744),
  new Segment(-201.453918457, -32.9904937744, -213.128265381, -38.1242332458),
  new Segment(-213.128265381, -38.1242332458, -224.116546631, -36.239818573),
  new Segment(-224.116546631, -36.239818573, -227.372329712, -30.3773860931),
  new Segment(-227.372329712, -30.3773860931, -226.194061279, -25.6673755646),
  new Segment(-226.194061279, -25.6673755646, -197.161407471, -12.2716627121),
  new Segment(-197.161407471, -12.2716627121, -191.803161621, -6.87643623352),
  new Segment(-191.803161621, -6.87643623352, -188.8878479, -0.701047480106),
  new Segment(-188.8878479, -0.701047480106, -188.009292603, 7.33984804153),
  new Segment(-188.009292603, 7.33984804153, -189.261154175, 15.4168405533),
  new Segment(-189.261154175, 15.4168405533, -192.497711182, 22.6426277161),
  new Segment(-192.497711182, 22.6426277161, -197.64680481, 28.5973548889),
  new Segment(-197.64680481, 28.5973548889, -204.501724243, 32.966835022),
  new Segment(-204.501724243, 32.966835022, -212.008834839, 35.3276748657),
  new Segment(-212.008834839, 35.3276748657, -228.534729004, 34.9863090515),
  new Segment(-228.534729004, 34.9863090515, -243.98348999, 28.3804168701),
  new Segment(-243.98348999, 28.3804168701, -250.0, 23.1456832886),
  new Segment(-180.291320801, 54.7960929871, -180.291320801, -29.3044166565),
  new Segment(-180.291320801, -29.3044166565, -167.803497314, -29.1048316956),
  new Segment(-167.803497314, -29.1048316956, -165.807052612, -28.1196193695),
  new Segment(-165.807052612, -28.1196193695, -164.161865234, -25.883562088),
  new Segment(-164.161865234, -25.883562088, -163.455368042, -23.0000247955),
  new Segment(-163.455368042, -23.0000247955, -156.25428772, -28.0170154572),
  new Segment(-156.25428772, -28.0170154572, -150.039093018, -30.0135555267),
  new Segment(-150.039093018, -30.0135555267, -141.833999634, -30.2129650116),
  new Segment(-141.833999634, -30.2129650116, -135.174209595, -28.1577510834),
  new Segment(-135.174209595, -28.1577510834, -129.520187378, -24.028131485),
  new Segment(-129.520187378, -24.028131485, -125.166770935, -18.0621013641),
  new Segment(-125.166770935, -18.0621013641, -121.811508179, -8.42022418976),
  new Segment(-121.811508179, -8.42022418976, -120.839263916, 4.5357670784),
  new Segment(-120.839263916, 4.5357670784, -122.426986694, 14.5890359879),
  new Segment(-122.426986694, 14.5890359879, -126.205322266, 23.231803894),
  new Segment(-126.205322266, 23.231803894, -131.307022095, 29.3968849182),
  new Segment(-131.307022095, 29.3968849182, -137.132232666, 33.3586082458),
  new Segment(-137.132232666, 33.3586082458, -143.995117188, 35.5414848328),
  new Segment(-143.995117188, 35.5414848328, -153.386001587, 35.5648498535),
  new Segment(-153.386001587, 35.5648498535, -160.484527588, 33.0321426392),
  new Segment(-160.484527588, 33.0321426392, -161.918319702, 32.1244659424),
  new Segment(-161.918319702, 32.1244659424, -161.918319702, 54.7960929871),
  new Segment(-161.918319702, 54.7960929871, -180.291320801, 54.7960929871),
  new Segment(-113.265800476, 35.0306396484, -113.265800476, -29.3044166565),
  new Segment(-113.265800476, -29.3044166565, -99.5910949707, -28.748670578),
  new Segment(-99.5910949707, -28.748670578, -97.129737854, -26.0631599426),
  new Segment(-97.129737854, -26.0631599426, -96.4132003784, -22.3947219849),
  new Segment(-96.4132003784, -22.3947219849, -91.3963851929, -27.4027900696),
  new Segment(-91.3963851929, -27.4027900696, -86.8511047363, -29.6747646332),
  new Segment(-86.8511047363, -29.6747646332, -80.3023605347, -30.3776168823),
  new Segment(-80.3023605347, -30.3776168823, -75.3952713013, -29.1551494598),
  new Segment(-75.3952713013, -29.1551494598, -72.9731674194, -27.644985199),
  new Segment(-72.9731674194, -27.644985199, -74.9461212158, -13.4393110275),
  new Segment(-74.9461212158, -13.4393110275, -90.3540420532, -10.5634880066),
  new Segment(-90.3540420532, -10.5634880066, -94.8927841187, -3.7752263546),
  new Segment(-94.8927841187, -3.7752263546, -94.8927841187, 35.0306396484),
  new Segment(-94.8927841187, 35.0306396484, -113.265800476, 35.0306396484),
  new Segment(-71.8531646729, 10.5293188095, -64.9131240845, 3.28125047684),
  new Segment(-64.9131240845, 3.28125047684, -51.9759101868, -1.64473056793),
  new Segment(-51.9759101868, -1.64473056793, -37.2720718384, -3.46818232536),
  new Segment(-37.2720718384, -3.46818232536, -37.9345626831, -10.141834259),
  new Segment(-37.9345626831, -10.141834259, -39.7131309509, -13.1500110626),
  new Segment(-39.7131309509, -13.1500110626, -42.5528755188, -14.7550754547),
  new Segment(-42.5528755188, -14.7550754547, -63.0819206238, -9.85042381287),
  new Segment(-63.0819206238, -9.85042381287, -67.8052444458, -13.336148262),
  new Segment(-67.8052444458, -13.336148262, -71.1781692505, -19.3919506073),
  new Segment(-71.1781692505, -19.3919506073, -66.5723266602, -23.2182998657),
  new Segment(-66.5723266602, -23.2182998657, -62.8707122803, -25.6006450653),
  new Segment(-62.8707122803, -25.6006450653, -58.9506340027, -27.5098361969),
  new Segment(-58.9506340027, -27.5098361969, -54.8203468323, -28.9411334991),
  new Segment(-54.8203468323, -28.9411334991, -50.4890632629, -29.8929824829),
  new Segment(-50.4890632629, -29.8929824829, -45.9651298523, -30.367023468),
  new Segment(-45.9651298523, -30.367023468, -37.0852508545, -29.7046413422),
  new Segment(-37.0852508545, -29.7046413422, -29.4976081848, -26.4612846375),
  new Segment(-29.4976081848, -26.4612846375, -24.2846450806, -21.5895404816),
  new Segment(-24.2846450806, -21.5895404816, -20.6524944305, -14.4604549408),
  new Segment(-20.6524944305, -14.4604549408, -19.2530670166, -5.11304855347),
  new Segment(-19.2530670166, -5.11304855347, -19.2530670166, 35.0306396484),
  new Segment(-19.2530670166, 35.0306396484, -31.5588493347, 34.3567466736),
  new Segment(-31.5588493347, 34.3567466736, -34.3891601562, 30.9659690857),
  new Segment(-34.3891601562, 30.9659690857, -35.0013542175, 28.9873447418),
  new Segment(-35.0013542175, 28.9873447418, -48.1527519226, 35.4344940186),
  new Segment(-48.1527519226, 35.4344940186, -59.9904518127, 35.3336677551),
  new Segment(-59.9904518127, 35.3336677551, -67.1097793579, 32.0651741028),
  new Segment(-67.1097793579, 32.0651741028, -71.6338729858, 26.5839061737),
  new Segment(-71.6338729858, 26.5839061737, -73.5248641968, 18.9983329773),
  new Segment(-73.5248641968, 18.9983329773, -71.8531646729, 10.5293188095),
  new Segment(-17.2131214142, -29.3044166565, 1.0320097208, -28.8499946594),
  new Segment(1.0320097208, -28.8499946594, 4.36510133743, -25.4535903931),
  new Segment(4.36510133743, -25.4535903931, 17.5672912598, 6.8057384491),
  new Segment(17.5672912598, 6.8057384491, 31.6103248596, -27.6520004272),
  new Segment(31.6103248596, -27.6520004272, 35.8215866089, -29.3044166565),
  new Segment(35.8215866089, -29.3044166565, 50.4026412964, -29.3044166565),
  new Segment(50.4026412964, -29.3044166565, 14.6275310516, 53.0352363586),
  new Segment(14.6275310516, 53.0352363586, 10.0847930908, 54.790512085),
  new Segment(10.0847930908, 54.790512085, -4.13282966614, 54.7960929871),
  new Segment(-4.13282966614, 54.7960929871, 8.09237384796, 28.5628223419),
  new Segment(8.09237384796, 28.5628223419, -17.2131214142, -29.3044166565),
  new Segment(67.1129837036, -43.0220756531, 70.8242797852, -46.1711845398),
  new Segment(70.8242797852, -46.1711845398, 107.532173157, -44.5661811829),
  new Segment(107.532173157, -44.5661811829, 106.474609375, -36.7771453857),
  new Segment(106.474609375, -36.7771453857, 104.588256836, -36.2171592712),
  new Segment(104.588256836, -36.2171592712, 77.6054840088, -36.2171592712),
  new Segment(77.6054840088, -36.2171592712, 77.6054840088, -11.7837839127),
  new Segment(77.6054840088, -11.7837839127, 105.958580017, -10.3419857025),
  new Segment(105.958580017, -10.3419857025, 104.976531982, -2.49414801598),
  new Segment(104.976531982, -2.49414801598, 103.090148926, -1.93415677547),
  new Segment(103.090148926, -1.93415677547, 77.6054840088, -1.93415677547),
  new Segment(77.6054840088, -1.93415677547, 76.0714111328, 31.6682910919),
  new Segment(76.0714111328, 31.6682910919, 67.4018707275, 30.8879585266),
  new Segment(67.4018707275, 30.8879585266, 67.1129837036, -43.0220756531),
  new Segment(120.095283508, -24.6303157806, 129.608703613, -25.2557296753),
  new Segment(129.608703613, -25.2557296753, 130.441635132, -23.1543998718),
  new Segment(130.441635132, -23.1543998718, 129.148803711, 31.5169696808),
  new Segment(129.148803711, 31.5169696808, 120.353370667, 30.8881187439),
  new Segment(120.353370667, 30.8881187439, 120.095283508, -24.6303157806),
  new Segment(119.322807312, -44.398109436, 121.180656433, -46.4573097229),
  new Segment(121.180656433, -46.4573097229, 127.222000122, -47.0964736938),
  new Segment(127.222000122, -47.0964736938, 130.192550659, -45.4785003662),
  new Segment(130.192550659, -45.4785003662, 131.452316284, -39.7855491638),
  new Segment(131.452316284, -39.7855491638, 130.463180542, -36.2580413818),
  new Segment(130.463180542, -36.2580413818, 127.909065247, -34.4520149231),
  new Segment(127.909065247, -34.4520149231, 121.851325989, -34.5460662842),
  new Segment(121.851325989, -34.5460662842, 120.161682129, -35.5619850159),
  new Segment(120.161682129, -35.5619850159, 118.715286255, -39.7347106934),
  new Segment(118.715286255, -39.7347106934, 119.322807312, -44.398109436),
  new Segment(146.138839722, -50.1553192139, 155.652313232, -50.7807121277),
  new Segment(155.652313232, -50.7807121277, 156.485198975, -48.6793899536),
  new Segment(156.485198975, -48.6793899536, 155.192459106, 31.5168952942),
  new Segment(155.192459106, 31.5168952942, 146.39680481, 30.8879547119),
  new Segment(146.39680481, 30.8879547119, 146.138839722, -50.1553192139),
  new Segment(172.182403564, -24.6303157806, 181.224731445, -25.4283256531),
  new Segment(181.224731445, -25.4283256531, 182.183029175, -23.1543998718),
  new Segment(182.183029175, -23.1543998718, 182.183029175, -20.4164428711),
  new Segment(182.183029175, -20.4164428711, 189.238937378, -25.3773441315),
  new Segment(189.238937378, -25.3773441315, 195.430908203, -27.1080703735),
  new Segment(195.430908203, -27.1080703735, 206.094833374, -25.155008316),
  new Segment(206.094833374, -25.155008316, 213.345077515, -17.9852924347),
  new Segment(213.345077515, -17.9852924347, 226.779342651, -26.7018451691),
  new Segment(226.779342651, -26.7018451691, 233.678161621, -26.9908695221),
  new Segment(233.678161621, -26.9908695221, 239.68598938, -25.2326545715),
  new Segment(239.68598938, -25.2326545715, 244.663024902, -21.4182262421),
  new Segment(244.663024902, -21.4182262421, 248.329696655, -14.9490556717),
  new Segment(248.329696655, -14.9490556717, 250.0, -3.72648978233),
  new Segment(250.0, -3.72648978233, 248.466049194, 31.6682338715),
  new Segment(248.466049194, 31.6682338715, 239.911621094, 30.8879547119),
  new Segment(239.911621094, 30.8879547119, 239.343734741, 29.0206775665),
  new Segment(239.343734741, 29.0206775665, 238.151824951, -11.353887558),
  new Segment(238.151824951, -11.353887558, 234.285140991, -16.4685173035),
  new Segment(234.285140991, -16.4685173035, 229.389038086, -17.5922107697),
  new Segment(229.389038086, -17.5922107697, 225.14024353, -16.194442749),
  new Segment(225.14024353, -16.194442749, 216.235580444, -7.70616054535),
  new Segment(216.235580444, -7.70616054535, 214.822525024, 31.5960159302),
  new Segment(214.822525024, 31.5960159302, 206.204803467, 30.8879547119),
  new Segment(206.204803467, 30.8879547119, 205.636917114, 29.0206775665),
  new Segment(205.636917114, 29.0206775665, 204.546188354, -10.96052742),
  new Segment(204.546188354, -10.96052742, 200.520721436, -16.4685173035),
  new Segment(200.520721436, -16.4685173035, 195.624588013, -17.5922107697),
  new Segment(195.624588013, -17.5922107697, 191.375793457, -16.194442749),
  new Segment(191.375793457, -16.194442749, 182.5287323, -7.71281337738),
  new Segment(182.5287323, -7.71281337738, 181.115722656, 31.5960159302),
  new Segment(181.115722656, 31.5960159302, 172.440353394, 30.8879547119),
  new Segment(172.440353394, 30.8879547119, 172.182403564, -24.6303157806),
]);
shape1.scale.set(1, 1);
shape1.position.x = window.innerWidth / 2.0
shape1.position.y = window.innerHeight / 2
shapes.push(shape1)
app.stage.addChild(shape1)
let new_positions = shape1.getSegmentsGlobalPosition();
console.log(new_positions);


// // Setup scene
const room = new Rectangle(-10, -10, window.innerWidth + 20, window.innerHeight + 20);


const walls = [
  // new Segment(0.0, 132.101699829, 13.9535665512, 113.098945618),
  // new Segment(13.9535665512, 113.098945618, 20.8865890503, 112.653991699),
  // new Segment(20.8865890503, 112.653991699, 43.8088417053, 124.527664185),
  // new Segment(43.8088417053, 124.527664185, 55.6325454712, 125.286499023),
  // new Segment(55.6325454712, 125.286499023, 64.5194091797, 123.125564575),
  // new Segment(64.5194091797, 123.125564575, 69.609664917, 119.325698853),
  // new Segment(69.609664917, 119.325698853, 72.5407562256, 113.781234741),
  // new Segment(72.5407562256, 113.781234741, 72.4838256836, 102.514633179),
  // new Segment(72.4838256836, 102.514633179, 65.3330307007, 95.4263305664),
  // new Segment(65.3330307007, 95.4263305664, 24.9319553375, 79.8470153809),
  // new Segment(24.9319553375, 79.8470153809, 14.4418716431, 70.3700790405),
  // new Segment(14.4418716431, 70.3700790405, 8.91020298004, 59.8571624756),
  // new Segment(8.91020298004, 59.8571624756, 6.764793396, 45.9022064209),
  // new Segment(6.764793396, 45.9022064209, 8.35349559784, 32.7058868408),
  // new Segment(8.35349559784, 32.7058868408, 13.941192627, 20.5737304688),
  // new Segment(13.941192627, 20.5737304688, 23.1850852966, 10.54737854),
  // new Segment(23.1850852966, 10.54737854, 35.8835220337, 3.33045959473),
  // new Segment(35.8835220337, 3.33045959473, 48.4692573547, 0.149368286133),
  // new Segment(48.4692573547, 0.149368286133, 65.2790298462, 0.0),
  // new Segment(65.2790298462, 0.0, 80.2229385376, 3.1819152832),
  // new Segment(80.2229385376, 3.1819152832, 93.2883300781, 9.33671569824),
  // new Segment(93.2883300781, 9.33671569824, 100.215515137, 14.5264129639),
  // new Segment(100.215515137, 14.5264129639, 103.275047302, 17.3299560547),
  // new Segment(103.275047302, 17.3299560547, 91.0840530396, 36.913848877),
  // new Segment(91.0840530396, 36.913848877, 82.2796096802, 36.9577941895),
  // new Segment(82.2796096802, 36.9577941895, 62.4930381775, 28.2567443848),
  // new Segment(62.4930381775, 28.2567443848, 43.8692550659, 31.450592041),
  // new Segment(43.8692550659, 31.450592041, 38.3511047363, 41.3866882324),
  // new Segment(38.3511047363, 41.3866882324, 40.3481254578, 49.3695678711),
  // new Segment(40.3481254578, 49.3695678711, 89.5549087524, 72.0736618042),
  // new Segment(89.5549087524, 72.0736618042, 98.6364593506, 81.2179107666),
  // new Segment(98.6364593506, 81.2179107666, 103.577552795, 91.6844329834),
  // new Segment(103.577552795, 91.6844329834, 105.066619873, 105.312759399),
  // new Segment(105.066619873, 105.312759399, 102.944854736, 119.00226593),
  // new Segment(102.944854736, 119.00226593, 97.4592819214, 131.249084473),
  // new Segment(97.4592819214, 131.249084473, 88.7321929932, 141.34161377),
  // new Segment(88.7321929932, 141.34161377, 77.1139602661, 148.747344971),
  // new Segment(77.1139602661, 148.747344971, 64.3903503418, 152.748672485),
  // new Segment(64.3903503418, 152.748672485, 36.3809814453, 152.17010498),
  // new Segment(36.3809814453, 152.17010498, 10.1972341537, 140.973937988),
  // new Segment(10.1972341537, 140.973937988, 0.0, 132.101699829),
  // new Segment(118.147613525, 185.745239258, 118.147613525, 43.2052307129),
  // new Segment(118.147613525, 43.2052307129, 139.312927246, 43.5435028076),
  // new Segment(139.312927246, 43.5435028076, 142.696670532, 45.2133331299),
  // new Segment(142.696670532, 45.2133331299, 145.485076904, 49.0031738281),
  // new Segment(145.485076904, 49.0031738281, 146.682479858, 53.890411377),
  // new Segment(146.682479858, 53.890411377, 158.887435913, 45.38722229),
  // new Segment(158.887435913, 45.38722229, 169.421417236, 42.0033416748),
  // new Segment(169.421417236, 42.0033416748, 183.328033447, 41.6653594971),
  // new Segment(183.328033447, 41.6653594971, 194.615539551, 45.1487121582),
  // new Segment(194.615539551, 45.1487121582, 204.198410034, 52.1478881836),
  // new Segment(204.198410034, 52.1478881836, 211.576934814, 62.2595825195),
  // new Segment(211.576934814, 62.2595825195, 217.263702393, 78.6013717651),
  // new Segment(217.263702393, 78.6013717651, 218.911529541, 100.560188293),
  // new Segment(218.911529541, 100.560188293, 216.22052002, 117.599235535),
  // new Segment(216.22052002, 117.599235535, 209.816711426, 132.247665405),
  // new Segment(209.816711426, 132.247665405, 201.169967651, 142.696716309),
  // new Segment(201.169967651, 142.696716309, 191.296966553, 149.411346436),
  // new Segment(191.296966553, 149.411346436, 179.665206909, 153.111053467),
  // new Segment(179.665206909, 153.111053467, 163.748840332, 153.150665283),
  // new Segment(163.748840332, 153.150665283, 151.717712402, 148.858032227),
  // new Segment(151.717712402, 148.858032227, 149.287612915, 147.319641113),
  // new Segment(149.287612915, 147.319641113, 149.287612915, 185.745239258),
  // new Segment(149.287612915, 185.745239258, 118.147613525, 185.745239258),
  // new Segment(231.747619629, 152.245239258, 231.747619629, 43.2052307129),
  // new Segment(231.747619629, 43.2052307129, 254.924530029, 44.1471557617),
  // new Segment(254.924530029, 44.1471557617, 259.096252441, 48.6987762451),
  // new Segment(259.096252441, 48.6987762451, 260.310699463, 54.9163208008),
  // new Segment(260.310699463, 54.9163208008, 268.813598633, 46.4282684326),
  // new Segment(268.813598633, 46.4282684326, 276.517272949, 42.577545166),
  // new Segment(276.517272949, 42.577545166, 287.616577148, 41.3862915039),
  // new Segment(287.616577148, 41.3862915039, 295.93347168, 43.4582214355),
  // new Segment(295.93347168, 43.4582214355, 300.038665771, 46.0177764893),
  // new Segment(300.038665771, 46.0177764893, 296.694763184, 70.0946426392),
  // new Segment(296.694763184, 70.0946426392, 270.580230713, 74.9688034058),
  // new Segment(270.580230713, 74.9688034058, 262.887634277, 86.4740753174),
  // new Segment(262.887634277, 86.4740753174, 262.887634277, 152.245239258),
  // new Segment(262.887634277, 152.245239258, 231.747619629, 152.245239258),
  // new Segment(301.936950684, 110.718521118, 313.699432373, 98.4339370728),
  // new Segment(313.699432373, 98.4339370728, 335.626434326, 90.0850067139),
  // new Segment(335.626434326, 90.0850067139, 360.547637939, 86.9944763184),
  // new Segment(360.547637939, 86.9944763184, 359.42477417, 75.6834640503),
  // new Segment(359.42477417, 75.6834640503, 356.410339355, 70.5849609375),
  // new Segment(356.410339355, 70.5849609375, 351.597320557, 67.8645858765),
  // new Segment(351.597320557, 67.8645858765, 316.803100586, 76.1773605347),
  // new Segment(316.803100586, 76.1773605347, 308.797637939, 70.2694854736),
  // new Segment(308.797637939, 70.2694854736, 303.080993652, 60.0056533813),
  // new Segment(303.080993652, 60.0056533813, 310.887298584, 53.5204620361),
  // new Segment(310.887298584, 53.5204620361, 317.161071777, 49.4826812744),
  // new Segment(317.161071777, 49.4826812744, 323.805145264, 46.2468414307),
  // new Segment(323.805145264, 46.2468414307, 330.805480957, 43.8209686279),
  // new Segment(330.805480957, 43.8209686279, 338.146453857, 42.2076873779),
  // new Segment(338.146453857, 42.2076873779, 345.813964844, 41.4042510986),
  // new Segment(345.813964844, 41.4042510986, 360.864257812, 42.5269165039),
  // new Segment(360.864257812, 42.5269165039, 373.724395752, 48.0240020752),
  // new Segment(373.724395752, 48.0240020752, 382.5597229, 56.2810058594),
  // new Segment(382.5597229, 56.2810058594, 388.715759277, 68.3639297485),
  // new Segment(388.715759277, 68.3639297485, 391.087615967, 84.2066268921),
  // new Segment(391.087615967, 84.2066268921, 391.087615967, 152.245239258),
  // new Segment(391.087615967, 152.245239258, 370.230834961, 151.10307312),
  // new Segment(370.230834961, 151.10307312, 365.433776855, 145.356124878),
  // new Segment(365.433776855, 145.356124878, 364.396209717, 142.002593994),
  // new Segment(364.396209717, 142.002593994, 342.106201172, 152.929718018),
  // new Segment(342.106201172, 152.929718018, 322.042785645, 152.758834839),
  // new Segment(322.042785645, 152.758834839, 309.976379395, 147.219146729),
  // new Segment(309.976379395, 147.219146729, 302.30859375, 137.92906189),
  // new Segment(302.30859375, 137.92906189, 299.103607178, 125.07245636),
  // new Segment(299.103607178, 125.07245636, 301.936950684, 110.718521118),
  // new Segment(394.545074463, 43.2052307129, 425.468353271, 43.9754180908),
  // new Segment(425.468353271, 43.9754180908, 431.117523193, 49.731918335),
  // new Segment(431.117523193, 49.731918335, 453.493591309, 104.40750885),
  // new Segment(453.493591309, 104.40750885, 477.294830322, 46.0058746338),
  // new Segment(477.294830322, 46.0058746338, 484.432403564, 43.2052307129),
  // new Segment(484.432403564, 43.2052307129, 509.145446777, 43.2052307129),
  // new Segment(509.145446777, 43.2052307129, 448.511077881, 182.760803223),
  // new Segment(448.511077881, 182.760803223, 440.811676025, 185.735778809),
  // new Segment(440.811676025, 185.735778809, 416.714569092, 185.745239258),
  // new Segment(416.714569092, 185.745239258, 437.434753418, 141.283081055),
  // new Segment(437.434753418, 141.283081055, 394.545074463, 43.2052307129),
];

walls.push(...shape1.getSegmentsGlobalPosition())
const blocks: Rectangle[] = [
  // new Rectangle(50, 150, 20, 20),
  // new Rectangle(150, 150, 40, 80),
  // new Rectangle(400, 400, 40, 40),
];

let lightSource = new Point(500, 50)
let segments = loadMap(room, blocks, walls);

let scene = new Container();
app.stage.addChild(scene);

let triangles = new Graphics();
app.stage.addChild(triangles);

let gradient_rect = new PIXI.Graphics();
app.stage.addChild(gradient_rect);
gradient_rect.beginTextureFill({ texture: texture, matrix: new PIXI.Matrix().translate(-256, -256) })
// gradient_rect.drawRect(-0, -0, 512, 512);
gradient_rect.drawRect(-256, -256, 512, 512);
gradient_rect.endFill();
gradient_rect.zIndex = -1
gradient_rect.scale.set(2.0, 2.0)
gradient_rect.mask = triangles;


drawScenePixi(scene, new Point(50, 50), room, blocks, walls);
const run = (lightSource: Point) => {


  requestAnimationFrame(() => {

    let endpoints = processSegments(lightSource, segments);
    let visibility = calculateVisibility(lightSource, endpoints);
    drawVisibilityTriangles(triangles, 0x00ff00, lightSource, visibility);

  })
}

canvas.addEventListener('mousemove', ({ pageX, pageY }) => {
  run(new Point(pageX, pageY));
  gradient_rect.position.set(pageX, pageY)
});

canvas.addEventListener('touchmove', ({ touches }) => {
  run(new Point(touches[0].pageX, touches[0].pageY));
  gradient_rect.position.set(touches[0].pageX, touches[0].pageY)
});

window.addEventListener("resize", () => {
  let width = window.innerWidth;
  let height = window.innerHeight;
  // canvas.width = width;
  // canvas.height = height;

  room.width = width + 20;
  room.height = height + 20;
  segments = loadMap(room, blocks, walls)
  drawScenePixi(scene, lightSource, room, blocks, walls);

  app.renderer.resize(width, height)
})

let event = new Event("resize");
window.dispatchEvent(event)

run(new Point(100, 100));
